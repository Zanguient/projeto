<!DOCTYPE html>
<html ng-app="statelessApp">
<head lang="en">
	<title>Stateless Authentication Example</title>			
	<script src="bower_components/angular/angular.js"></script>
</head>
<body ng-controller="AuthCtrl" ng-init="init()" style="padding: 10% 20%">
	<div ng-hide="authenticated">
		teste 2 Login as user/user or admin/admin:<br>
		<label for="un">Username:</label><input id="un" type="text" ng-model="username"><br>
		<label for="pw">Password:</label><input id="pw" type="password" ng-model="password"><br>
		<button ng-click="login()">Login</button>
	</div>
	<div ng-show="authenticated">
		Logged in as {{username}} <button ng-click="logout()">Logout</button><br><br>
		Token content: <pre>{{token | json}}</pre>
	</div>
</body>
<script type="text/javascript">
	var app = angular.module('statelessApp', []).factory('TokenStorage', function() {
	var storageKey = 'auth_token';
	return {		
		store : function(token) {
			return localStorage.setItem(storageKey, token);
		},
		retrieve : function() {
			return localStorage.getItem(storageKey);
		},
		clear : function() {
			return localStorage.removeItem(storageKey);
		}
	};
}).factory('TokenAuthInterceptor', function($q, TokenStorage) {
	return {
		request: function(config) {
			var authToken = TokenStorage.retrieve();
			if (authToken) {
				config.headers['X-AUTH-TOKEN'] = authToken;
			}
			return config;
		},
		responseError: function(error) {
			if (error.status === 401 || error.status === 403) {
				TokenStorage.clear();
			}
			return $q.reject(error);
		}
	};
}).config(function($httpProvider) {
	$httpProvider.interceptors.push('TokenAuthInterceptor');
});

app.controller('AuthCtrl', function ($scope, $http, TokenStorage) {
	$scope.authenticated = false;
	$scope.token; // For display purposes only
	
	$scope.init = function () {
		$http.get('http://localhost:8080/api/users/current').success(function (user) {
			if(user.username !== 'anonymousUser'){
				$scope.authenticated = true;
				$scope.username = user.username;
				
				// For display purposes only
				var tt = TokenStorage.retrieve();
				$scope.token = tt !== 'null' ? JSON.parse(atob(tt.split('.')[0])) : null;
			}
		});
	};

	$scope.login = function () {
		$http.post('http://localhost:8080/api/login', { username: $scope.username, password: $scope.password }).success(function (result, status, headers) {
			$scope.authenticated = true;
			TokenStorage.store(headers('X-AUTH-TOKEN'));
			
			// For display purposes only
			var tt = TokenStorage.retrieve();
			$scope.token = tt !== 'null' ? JSON.parse(atob(tt.split('.')[0])) : null;
		});  
	};

	$scope.logout = function () {
		// Just clear the local storage
		TokenStorage.clear();	
		$scope.authenticated = false;
	};
});
</script>
</html>